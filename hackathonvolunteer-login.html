<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Volunteer Login</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, Arial, sans-serif; 
      max-width: 520px; 
      margin: 8vh auto; 
      padding: 0 16px;
      background: #f9fafb;
    }
    .card { 
      background: white;
      border: 1px solid #e5e7eb; 
      padding: 32px; 
      border-radius: 16px; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    h1 { 
      margin: 0 0 8px; 
      font-size: 1.875rem;
      color: #111827;
    }
    p { 
      margin: 8px 0 24px; 
      color: #6b7280; 
      line-height: 1.5;
    }
    label { 
      display: block; 
      margin: 0 0 8px; 
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }
    input[type=email] { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #d1d5db; 
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type=email]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    button { 
      width: 100%;
      margin-top: 16px; 
      padding: 12px 16px; 
      border: 0; 
      border-radius: 10px; 
      background: #111827; 
      color: #fff; 
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    button:hover { 
      background: #1f2937; 
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .msg { 
      margin-top: 16px; 
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .ok { 
      background: #d1fae5;
      color: #065f46; 
      border: 1px solid #a7f3d0;
    }
    .err { 
      background: #fee2e2;
      color: #991b1b; 
      border: 1px solid #fecaca;
    }
    .hidden { display: none; }
    .profile { 
      margin-top: 24px; 
      padding: 20px; 
      background: #f9fafb; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px;
    }
    .greeting {
      font-weight: 600;
      font-size: 1.125rem;
      color: #111827;
      margin-bottom: 8px;
    }
    .details { 
      color: #6b7280; 
      font-size: 0.875rem;
      line-height: 1.6;
    }
    .detail-row {
      margin: 4px 0;
    }
    .detail-label {
      font-weight: 600;
      color: #374151;
    }
    details {
      margin-top: 16px;
    }
    summary {
      cursor: pointer;
      color: #6b7280;
      font-size: 0.875rem;
      padding: 8px 0;
    }
    summary:hover {
      color: #111827;
    }
    pre { 
      background: #0f172a; 
      color: #e2e8f0; 
      padding: 16px; 
      border-radius: 8px; 
      overflow: auto;
      font-size: 0.8125rem;
      line-height: 1.5;
      margin: 8px 0 0;
    }
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .debug-info {
      margin-top: 16px;
      padding: 12px;
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      font-size: 0.875rem;
      color: #92400e;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸŽ¯ Volunteer Login</h1>
    <p>Enter the email you used to register as a volunteer. We'll verify your access.</p>

    <label for="email">Email Address</label>
    <input id="email" type="email" placeholder="you@example.com" required />

    <button id="btn">
      <span id="btnText">Verify Access</span>
    </button>
    <div id="msg" class="msg hidden"></div>

    <div id="profile" class="profile hidden">
      <div id="greeting" class="greeting"></div>
      <div id="details" class="details"></div>
      <details>
        <summary>View Response Data</summary>
        <pre id="dbg"></pre>
      </details>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const API_URL = "https://script.google.com/macros/s/AKfycbz0FkcYV_Wkt5Iv1BKzJw6KXIoqXgfyBPDfAVRlLjsJbZ1Iq9eqX-hT5EEkTJGxNgfs5w/exec";

    // === UTIL ===
    const $ = (id) => document.getElementById(id);

    function safeOriginParam() {
      const o = (window.location && window.location.origin) || "";
      if (!o) return "";
      const low = o.toLowerCase();
      if (low === "null" || low.startsWith("file:")) return "";
      return o;
    }

    function setLoading(isLoading) {
      const btn = $("btn");
      const btnText = $("btnText");
      btn.disabled = isLoading;
      if (isLoading) {
        btnText.innerHTML = 'Verifying<span class="spinner"></span>';
      } else {
        btnText.textContent = "Verify Access";
      }
    }

    function showMessage(text, type) {
      const msg = $("msg");
      msg.textContent = text;
      msg.className = `msg ${type}`;
      msg.classList.remove("hidden");
    }

    function hideMessage() {
      $("msg").classList.add("hidden");
    }

    // JSONP request function with timeout
    function jsonpRequest(url, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
        let timeoutId;
        let script;
        
        // Cleanup function
        const cleanup = () => {
          if (timeoutId) clearTimeout(timeoutId);
          if (window[callbackName]) delete window[callbackName];
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        };
        
        // Success callback
        window[callbackName] = function(data) {
          cleanup();
          resolve(data);
        };

        // Create and append script
        script = document.createElement('script');
        script.src = url + '&callback=' + callbackName;
        
        script.onerror = function(e) {
          cleanup();
          console.error("Script loading error:", e);
          reject(new Error('Failed to load script. Check if the Apps Script URL is correct and the deployment is active.'));
        };

        // Timeout
        timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('Request timeout. The server took too long to respond.'));
        }, timeoutMs);
        
        document.body.appendChild(script);
      });
    }

    // Handle Enter key in email input
    $("email").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        $("btn").click();
      }
    });

    $("btn").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const profile = $("profile");
      const greet = $("greeting");
      const details = $("details");
      const dbg = $("dbg");

      hideMessage();
      profile.classList.add("hidden");
      greet.textContent = "";
      details.innerHTML = "";
      dbg.textContent = "";

      if (!email) {
        showMessage("Please enter your email address.", "err");
        return;
      }

      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage("Please enter a valid email address.", "err");
        return;
      }

      setLoading(true);

      try {
        const params = new URLSearchParams({ email });
        const origin = safeOriginParam();
        if (origin) params.set("origin", origin);

        const url = `${API_URL}?${params.toString()}`;
        
        console.log("Making request to:", url);
        
        // Use JSONP to bypass CORS
        const data = await jsonpRequest(url);

        console.log("Received data:", data);

        if (!data || data.allowed !== true) {
          const errorMsg = data?.error
            ? `Access denied: ${data.error}`
            : "This email is not registered in our volunteer database.";
          showMessage(errorMsg, "err");
          if (data) {
            dbg.textContent = JSON.stringify(data, null, 2);
          }
          return;
        }

        // Success â€” show greeting and details
        const discord = (data.discord || "").trim();
        greet.textContent = `Welcome, ${data.email || email}!`;
        if (discord) {
          greet.textContent += ` ðŸ’¬`;
        }

        const detailsHTML = [];
        if (data.position) {
          detailsHTML.push(`<div class="detail-row"><span class="detail-label">Position:</span> ${data.position}</div>`);
        }
        if (data.company) {
          detailsHTML.push(`<div class="detail-row"><span class="detail-label">Organization:</span> ${data.company}</div>`);
        }
        if (discord) {
          detailsHTML.push(`<div class="detail-row"><span class="detail-label">Discord:</span> ${discord}</div>`);
        }
        if (data.timestamp) {
          const date = new Date(data.timestamp);
          const formatted = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          detailsHTML.push(`<div class="detail-row"><span class="detail-label">Registered:</span> ${formatted}</div>`);
        }
        
        details.innerHTML = detailsHTML.join('');

        showMessage("âœ“ Access granted. Welcome to the volunteer portal!", "ok");
        profile.classList.remove("hidden");
        dbg.textContent = JSON.stringify(data, null, 2);

      } catch (e) {
        console.error("Login error:", e);
        showMessage(e.message || "Network error. Please check your connection and try again.", "err");
        
        // Show helpful debug info
        const debugDiv = document.createElement('div');
        debugDiv.className = 'debug-info';
        debugDiv.innerHTML = `
          <strong>Troubleshooting:</strong><br>
          1. Check if the Apps Script is deployed as "Anyone" can access<br>
          2. Make sure the deployment URL is correct<br>
          3. Try opening this URL directly: <a href="${API_URL}?email=test@test.com&callback=test" target="_blank">Test API</a><br>
          4. Error: ${e.message}
        `;
        const msg = $("msg");
        if (msg.nextSibling) {
          msg.parentNode.insertBefore(debugDiv, msg.nextSibling);
        } else {
          msg.parentNode.appendChild(debugDiv);
        }
      } finally {
        setLoading(false);
      }
    });

    // Focus email input on load
    window.addEventListener("load", () => {
      $("email").focus();
    });
  </script>
</body>
</html>