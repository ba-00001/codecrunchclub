<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Code Crunch ‚Äì Membership Certificate</title>
<style>
  :root{--brand:#1e40af;--brand2:#2563EB;}
  *{box-sizing:border-box} body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:24px}
  .card{max-width:780px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.12);overflow:hidden}
  .header{padding:28px;background:linear-gradient(135deg,var(--brand2),var(--brand));color:#fff;text-align:center}
  .logo{width:56px;height:56px;border-radius:12px;background:#F59E0B;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-weight:800}
  .body{padding:32px}
  label{font-weight:600;color:#374151;margin-bottom:8px;display:block}
  input{width:100%;padding:14px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px}
  input:focus{outline:none;border-color:var(--brand2);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .btn{margin-top:16px;width:100%;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--brand2),var(--brand));color:#fff;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .status{margin-top:16px;padding:12px;border-radius:10px;display:none;font-weight:600}
  .status.info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
  .status.ok{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
  .status.err{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
  .result{display:none;margin-top:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .item small{color:#6b7280;font-weight:600;display:block}
  .links{margin-top:18px;background:#f8fafc;padding:16px;border-radius:12px;text-align:center}
  .links a{display:inline-block;margin:6px 8px;padding:10px 16px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700}
  .links .discord{background:#5865F2}.links .groupme{background:#00AFF0}
  .download{margin-top:12px;width:100%;padding:14px;border:none;border-radius:10px;background:#10b981;color:#fff;font-weight:700;cursor:pointer}
  .debug{margin-top:16px;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#f3f4f6;padding:12px;border-radius:10px;max-height:220px;overflow:auto;display:none}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="logo">CC</div>
      <h1 style="margin:6px 0 2px">Code Crunch</h1>
      <div>Membership Certificate Generator</div>
    </div>
    <div class="body">
      <label for="email">Enter your registered email address</label>
      <input id="email" type="email" placeholder="your.email@example.com" />
      <button id="go" class="btn">üèÜ Generate My Certificate</button>

      <div id="status" class="status"></div>

      <div id="result" class="result">
        <div class="grid">
          <div class="item"><small>Name</small><div id="r_name">‚Äî</div></div>
          <div class="item"><small>Member Since</small><div id="r_since">‚Äî</div></div>
          <div class="item"><small>Membership ID</small><div id="r_id">‚Äî</div></div>
          <div class="item"><small>Organization</small><div id="r_org">Code Crunch</div></div>
        </div>
        <div class="links" id="links" style="display:none">
          <div style="margin-bottom:6px;font-weight:700;color:#1e40af">üåü Join Our Community</div>
          <a id="lnk_discord" class="discord" target="_blank" rel="noopener">üí¨ Join Discord</a>
          <a id="lnk_groupme" class="groupme" target="_blank" rel="noopener">üë• Join GroupMe</a>
        </div>
        <button id="dl" class="download">üìÑ Download Certificate</button>
      </div>

      <div id="debug" class="debug"></div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_URL = 'https://script.google.com/macros/s/AKfycbwKujBRsNpb14Wt5fvjKxLONMAqB-W53fpFrRdzwcZZAFA65EEak6W862qALPhLH3BHGg/exec';
  let certData = null;

  // UI helpers
  const el = id => document.getElementById(id);
  const status = (type, msg) => {
    const box = el('status');
    box.className = 'status ' + (type==='ok'?'ok':type==='err'?'err':'info');
    box.textContent = msg;
    box.style.display = 'block';
  };
  const debug = (label, data) => {
    const d = el('debug');
    d.style.display = 'block';
    d.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${label}</div>`;
    if (data) d.innerHTML += `<pre>${escapeHtml(JSON.stringify(data,null,2))}</pre>`;
    d.scrollTop = d.scrollHeight;
  };
  const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // Main action
  async function go() {
    const email = el('email').value.trim().toLowerCase();
    el('result').style.display = 'none';
    status('info', '‚è≥ Checking membership‚Ä¶');
    el('go').disabled = true;

    if (!email)   { status('err','‚ùå Please enter your email address.'); el('go').disabled=false; return; }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      status('err','‚ùå Please enter a valid email address.'); el('go').disabled=false; return;
    }

    try {
      const referer = window.location.href; // server will decode & verify domain
      const url = `${API_URL}?email=${encodeURIComponent(email)}&referer=${encodeURIComponent(referer)}`;
      debug('Request', { url });

      const ac = new AbortController();
      const to = setTimeout(() => ac.abort(), 15000);
      const res = await fetch(url, { signal: ac.signal, headers: { 'Accept':'application/json' }});
      clearTimeout(to);

      debug('Response meta', { status: res.status, ok: res.ok });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      debug('Response JSON', data);

      if (data.error) throw new Error(data.error);

      const list = Array.isArray(data.certificates) ? data.certificates : [];
      if (!list.length) { status('err','‚ùå No membership found for this email.'); return; }

      const c = list[0].certificateData || list[0];
      certData = c;

      // Populate UI
      el('r_name').textContent  = c.participantName || 'Member';
      el('r_since').textContent = c.memberDateSince || '‚Äî';
      el('r_id').textContent    = c.membershipID || '‚Äî';
      el('r_org').textContent   = c.orgName || 'Code Crunch';

      // Links
      const links = el('links');
      const d = el('lnk_discord'), g = el('lnk_groupme');
      let showLinks = false;
      if (c.discordJoinLink) { d.href = c.discordJoinLink; d.style.display='inline-block'; showLinks = true; } else d.style.display='none';
      if (c.groupmeLink)     { g.href = c.groupmeLink;     g.style.display='inline-block'; showLinks = true; } else g.style.display='none';
      links.style.display = showLinks ? 'block' : 'none';

      status('ok','‚úÖ Membership verified! Welcome to Code Crunch Global.');
      el('result').style.display = 'block';
      setTimeout(()=>el('result').scrollIntoView({behavior:'smooth'}), 100);

    } catch (err) {
      debug('Error', { message: err.message });
      status('err', `‚ùå ${err.message}`);
    } finally {
      el('go').disabled = false;
    }
  }

  function download() {
    if (!certData) return alert('Generate your certificate first.');
    const c = certData;
    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>Code Crunch Certificate - ${escapeHtml(c.participantName || 'Member')}</title>
<style>
  @page { size:A4 landscape; margin:10mm }
  body{font-family:"Times New Roman",serif;background:#f5f5f5;margin:0;padding:20px}
  .sheet{max-width:1000px;min-height:700px;margin:0 auto;background:#fff;border:15px solid #B8860B;padding:40px;position:relative}
  .hdr{text-align:center;margin-bottom:40px}
  .ttl{font-size:4rem;font-weight:700;letter-spacing:4px;color:#333;margin:0 0 10px}
  .sub{font-size:1.2rem;letter-spacing:4px;color:#666;text-transform:uppercase}
  .presented{font-size:1.1rem;font-style:italic;margin-top:40px;text-align:center;color:#555}
  .name{font-size:3rem;font-weight:700;font-style:italic;color:#333;margin:20px 0;text-align:center}
  .rec{font-size:1.1rem;line-height:1.6;color:#555;margin:30px auto;max-width:80%;text-align:center}
  .info{font-size:1.1rem;font-weight:700;color:#333;margin:20px 0;text-align:center}
  .sig{position:absolute;right:40px;bottom:40px;text-align:center}
  .line{border-top:2px solid #333;width:200px;margin-bottom:10px}
  .logo{position:absolute;top:20px;right:20px;width:80px;height:80px;object-fit:contain}
  @media print{ body{background:#fff!important;padding:0!important}.sheet{width:277mm;height:190mm;border:8mm solid #B8860B;padding:15mm;margin:0}}
</style></head>
<body>
<div class="sheet">
  ${c.orgLogoUrl ? `<img class="logo" src="${escapeHtml(c.orgLogoUrl)}" alt="Logo">` : ''}
  <div class="hdr"><div class="ttl">MEMBERSHIP CERTIFICATE</div><div class="sub">CODE CRUNCH GLOBAL</div></div>
  <div class="presented">This certificate confirms that</div>
  <div class="name">${escapeHtml(c.participantName || 'Member')}</div>
  <div class="rec">is an official member of <strong>${escapeHtml(c.orgName || 'Code Crunch')}</strong>, recognized for their commitment to collaborative coding, innovation, and community building.</div>
  <div class="info">Member Since: ${escapeHtml(c.memberDateSince || '‚Äî')}<br>Membership ID: ${escapeHtml(c.membershipID || '‚Äî')}</div>
  <div class="sig"><div class="line"></div><div><strong>BRIAN BAZURTO</strong><div style="font-style:italic;color:#666">Code Crunch President</div></div></div>
</div></body></html>`;
    const w = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
    if (!w) return alert('Please allow pop-ups to view your certificate.');
    w.document.write(html); w.document.close();
  }

  el('go').addEventListener('click', go);
  el('email').addEventListener('keydown', e => { if (e.key === 'Enter') go(); });
  el('dl').addEventListener('click', download);
</script>
</body>
</html>
