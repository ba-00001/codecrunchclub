<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Certificates ‚Ä¢ Code Crunch</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <!-- üîí STYLES UNCHANGED -->
  <!-- (Your full CSS block remains exactly the same) -->
</head>

<body>
  <!-- NAV (UNCHANGED) -->
  <!-- TIMEZONE (UNCHANGED) -->

  <main class="container">
    <section class="surface" id="certificate-generator">
      <h2 class="card-title" style="text-align:center">
        GENERATE YOUR CERTIFICATE ‚Ä¢ EmpowHer Hackathon 2025 Session B (In-person)
      </h2>
      <p class="card-description" style="text-align:center">
        [ OFFICIAL CERTIFICATE ] ‚Äî Use your registered email
      </p>

      <div class="cg-row">
        <input type="email" id="certificateEmailInput" class="cg-input"
               placeholder="Enter your registered email address"/>
        <button id="generateBtn" class="cg-btn" onclick="generateCertificate()">
          üèÜ Generate Certificate
        </button>
      </div>

      <div id="certificateResult" class="surface" style="margin-top:1rem"></div>
    </section>
  </main>

  <!-- FOOTER (UNCHANGED) -->

<script>
/* ================= SETTINGS ================= */
const CERT_API_URL =
  'https://script.google.com/macros/s/AKfycbzswM2rda7UUR2XpWwkv-6T9EcKI_fKygwCRZk7kiWQCbMb0FxnAy3rfSuS5PdQtW5bOg/exec';

/* ================= HELPERS ================= */
const esc = s =>
  String(s ?? '').replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

function setStatus(type, html) {
  const cls =
    type === 'ok' ? 'alert-ok' :
    type === 'error' ? 'alert-error' : 'alert-info';

  document.getElementById('certificateResult').innerHTML =
    `<div class="infobox">
       <strong>üèÜ Certificate Generator</strong><br>
       Use your registered email to check eligibility
     </div>
     <div class="alert ${cls}">${html}</div>`;
}

function toggleButton(loading) {
  const btn = document.getElementById('generateBtn');
  btn.disabled = loading;
  btn.textContent = loading ? '‚è≥ Checking‚Ä¶' : 'üèÜ Generate Certificate';
}

/* ================= CERT GENERATION ================= */
async function generateCertificate() {
  const email =
    document.getElementById('certificateEmailInput').value.trim();

  if (!email) {
    setStatus('error', '‚ùå Please enter your email address.');
    return;
  }

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    setStatus('error', '‚ùå Please enter a valid email address.');
    return;
  }

  toggleButton(true);
  setStatus('info', '‚è≥ Checking your volunteer record‚Ä¶');

  try {
    const res = await fetch(
      `${CERT_API_URL}?email=${encodeURIComponent(email)}&referer=${encodeURIComponent(location.href)}`
    );
    const payload = await res.json();

    const cert = payload?.certificates?.[0];
    if (!cert) {
      setStatus('error', 'No record found for this email.');
      return;
    }

    /* ‚úÖ Always show ticket + DB link */
    let headerInfo = `
      <strong>Ticket ID:</strong> ${esc(cert.ticketId || '‚Äî')}<br>
      <a href="${esc(cert.volunteerDatabaseUrl)}" target="_blank">
        View Volunteer Database Record
      </a><br><br>
    `;

    /* ‚ùå Donation not verified */
    if (cert.status !== 'Certificate Available') {
      setStatus(
        'error',
        headerInfo +
        `<pre style="white-space:pre-wrap;font-family:inherit">
${esc(cert.nextStepsMessage || cert.message)}
</pre>`
      );
      return;
    }

    /* ‚úÖ Donation verified ‚Üí generate certificate */
    setStatus(
      'ok',
      headerInfo +
      '<strong>‚úÖ Certificate verified.</strong> Opening in a new tab‚Ä¶'
    );

    openCertificatesInNewTab(
      [normalizeCert(cert.certificateData)],
      true
    );

  } catch (err) {
    console.error(err);
    setStatus('error', '‚ùå Failed to check records. Please try again later.');
  } finally {
    toggleButton(false);
  }
}

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('certificateResult').innerHTML =
    '<div class="infobox">Enter your email above to check your certificate status.</div>';
});
</script>

</body>
</html>
