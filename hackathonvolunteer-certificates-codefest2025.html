<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Certificates â€¢ Code Crunch</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f8f9fa;color:#202124}

    .navbar{background:#fff;border-bottom:1px solid #ddd;padding:14px}
    .nav-container{max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center}
    .nav-brand a{font-weight:700;color:#1a73e8;text-decoration:none}
    .nav-links a{margin-left:14px;color:#555;text-decoration:none;font-size:14px}

    .container{max-width:1100px;margin:auto;padding:24px}
    .surface{background:#fff;border:1px solid #ddd;border-radius:12px;padding:24px}

    .cg-row{display:flex;gap:10px;flex-wrap:wrap}
    .cg-input{flex:1;padding:12px;font-size:16px;border-radius:8px;border:2px solid #ccc}
    .cg-btn{padding:12px 20px;border-radius:8px;border:none;font-weight:700;background:#0d6efd;color:#fff;cursor:pointer}
    .cg-btn[disabled]{opacity:.6;cursor:not-allowed}

    .alert{margin-top:16px;padding:14px;border-radius:8px;border:1px solid}
    .alert-ok{background:#e6f4ea;color:#155724;border-color:#c3e6cb}
    .alert-error{background:#f8d7da;color:#721c24;border-color:#f5c6cb}
    .alert-info{background:#e3f2fd;color:#084298;border-color:#bbdefb}

    .mono{font-family:"Courier New",monospace;font-weight:700}
    .btn-muted{
      display:inline-block;
      margin-top:10px;
      padding:10px 16px;
      border-radius:6px;
      background:#6c757d;
      color:#fff;
      text-decoration:none;
      font-weight:600;
    }
    .copy-btn{
      margin-top:10px;
      background:#198754;
    }

    textarea{
      width:100%;
      min-height:260px;
      margin-top:10px;
      padding:10px;
      font-family:Courier New,monospace;
      font-size:14px;
      border-radius:8px;
      border:1px solid #ccc;
      resize:vertical;
    }
  </style>
</head>

<body>

<nav class="navbar">
  <div class="nav-container">
    <div class="nav-brand">
      <a href="https://hackuniversity.vercel.app" target="_blank">Hack University Initiative</a>
    </div>
    <div class="nav-links">
      <a href="https://codecrunchglobal.vercel.app">Code Crunch</a>
      <a href="https://gdgatfiu.vercel.app">GDG FIU</a>
      <a href="https://colorstackatfiu.vercel.app">ColorStack</a>
    </div>
  </div>
</nav>

<main class="container">
  <section class="surface">
    <h2 style="text-align:center">Generate Your Volunteer Certificate</h2>
    <p style="text-align:center;color:#666">Use the email you registered with</p>

    <div class="cg-row">
      <input id="emailInput" class="cg-input" type="email" placeholder="you@example.com"/>
      <button id="btn" class="cg-btn">Check</button>
    </div>

    <div id="result"></div>
  </section>
</main>

<script>
const CERT_API_URL =
  'https://script.google.com/macros/s/AKfycbz8kaKWeN2V5pevaRaeVpg-erjXqc-tP8jjVrsuSLrKtYKWMgwyuhaKEC2pb6p74q2p_Q/exec';

const esc = s => String(s ?? '').replace(/[&<>"']/g,
  m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
);
const nl2br = s => esc(s).replace(/\n/g,'<br>');

document.getElementById('btn').onclick = run;
document.getElementById('emailInput').addEventListener('keydown',e=>{ if(e.key==='Enter') run(); });

async function run(){
  const email = document.getElementById('emailInput').value.trim();
  const out = document.getElementById('result');

  if(!email){
    out.innerHTML = alertHTML('error','Please enter your email address.');
    return;
  }

  document.getElementById('btn').disabled = true;
  out.innerHTML = alertHTML('info','Checking volunteer recordsâ€¦');

  try{
    const res = await fetch(`${CERT_API_URL}?email=${encodeURIComponent(email)}&referer=${encodeURIComponent(location.href)}`);
    const data = await res.json();
    const list = data?.certificates || [];

    if(!list.length){
      out.innerHTML = alertHTML('error','No volunteer record found for this email.');
      return;
    }

    const r = list[0];

    let html = `
      <div class="alert alert-info">
        <strong>Ticket ID:</strong>
        <span class="mono">${esc(r.ticketId || 'â€”')}</span><br><br>
        <a class="btn-muted" href="${esc(r.volunteerDatabaseUrl)}" target="_blank">
          ðŸ“„ Volunteer Database responses
        </a>
      </div>
    `;

    if(r.status !== 'Certificate Available'){
      html += `
        <div class="alert alert-error">
          <strong>Certificate Not Available</strong><br>
          ${esc(r.message)}
        </div>

        <div class="alert alert-info">
          <strong>Next Steps</strong><br><br>
          ${nl2br(r.nextStepsMessage)}
          <textarea id="emailTemplate">${r.nextStepsMessage}</textarea>
          <button class="cg-btn copy-btn" onclick="copyEmail()">ðŸ“‹ Copy Email Template</button>
        </div>
      `;
      out.innerHTML = html;
      return;
    }

    html += alertHTML('ok','Certificate available. Opening certificate in a new tabâ€¦');
    out.innerHTML = html;

    openCertificatesInNewTab([normalizeCert(r.certificateData)], true);

  }catch(e){
    console.error(e);
    out.innerHTML = alertHTML('error','Failed to load records.');
  }finally{
    document.getElementById('btn').disabled = false;
  }
}

function alertHTML(type,msg){
  return `<div class="alert alert-${type}">${msg}</div>`;
}

function copyEmail(){
  const ta = document.getElementById('emailTemplate');
  ta.select();
  document.execCommand('copy');
  alert('Email template copied to clipboard.');
}
</script>

</body>
</html>
