<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Membership Certificates ‚Ä¢ Code Crunch</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root{
      --matrix-green:#00e676;
      --cyber-blue:#00b0ff;
      --warning:#ffc107;
      --text-secondary:#4b5563;
      --text-light:#6b7280;
      --logo-h:52px; /* auto-adjusted in print tab */
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Google Sans','Roboto',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f8f9fa;color:#202124;min-height:100vh}

    /* NAV */
    .navbar{background:#fff;border-bottom:1px solid #e8eaed;padding:12px 0;position:sticky;top:0;z-index:100}
    .nav-container{max-width:1100px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
    .nav-brand a{color:#4285f4;text-decoration:none;font-size:22px;font-weight:600}
    .nav-links{display:flex;gap:20px;flex-wrap:wrap}
    .nav-link{color:#5f6368;text-decoration:none;font-size:14px;padding:8px 12px;border-radius:6px}
    .nav-link:hover{background:#f1f3f4;color:#1a73e8}

    /* Main */
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .surface{background:#fff;border:1px solid #dadce0;border-radius:12px;padding:24px}
    .infobox{background:#f8f9fa;padding:1rem;border-radius:8px;border-left:4px solid #28a745;margin-bottom:1rem}
    .alert{padding:.75rem;border-radius:4px;border:1px solid}
    .alert-info{color:#0066cc;background:#e3f2fd;border-color:#bbdefb}
    .alert-error{color:#721c24;background:#f8d7da;border-color:#f5c6cb}
    .alert-ok{color:#155724;background:#d4edda;border-color:#c3e6cb}

    /* Generator UI */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .cg-row{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}
    .cg-input{flex:1 1 300px;padding:.75rem;border-radius:8px;border:2px solid #ddd;background:#fff;color:#333;font-size:1rem;font-family:"Courier New",monospace}
    .cg-btn{padding:.75rem 1.5rem;font-size:1rem;background:#007bff;color:#fff;border:0;border-radius:8px;cursor:pointer;font-family:"Courier New",monospace;font-weight:bold;transition:all .3s ease}
    .cg-btn[disabled]{opacity:.6;cursor:not-allowed}

    /* CERTIFICATE PAGE (Membership) */
    .certificate-page{
      background:#fff;border:8px solid #B8860B;border-radius:10px;color:#333;
      font-family:"Times New Roman",serif;margin:0 auto 24px;box-sizing:border-box;
      width:1123px;height:794px;padding:40px;
      display:flex;flex-direction:column;page-break-inside:avoid;
      position:relative;
    }
    .certificate-page h1{font-size:3.5rem;font-weight:700;margin-bottom:.5rem;letter-spacing:3px;color:#333}
    .certificate-page .sub{font-size:1.2rem;color:#666;letter-spacing:4px}
    .presented{font-style:italic;margin:30px 0;font-size:1.1rem;text-align:center}
    .participant-name{font-size:3rem;font-weight:700;margin:40px 0;font-style:italic;text-align:center}
    .body-text{font-size:1.1rem;line-height:1.8;margin:30px 0;color:#555;text-align:center}
    .hack-logo{position:absolute;top:30px;right:30px;max-width:150px;max-height:80px;object-fit:contain}

    .content-wrap{flex:1 1 auto;min-height:0}
    .cert-bottom{margin-top:auto}

    /* Signature + ID + Logos */
    .sig-block{text-align:center;max-width:360px;margin:0 auto}
    .sig-img{max-height:75px;object-fit:contain;margin:0 auto 6px;display:block}
    .signature-script{font-family:'Great Vibes', cursive;font-size:2.1rem;line-height:1;transform:rotate(-2deg);color:#222;letter-spacing:.5px;margin-bottom:10px}
    .sig-line{border-top:2px solid #333;width:260px;margin:0 auto 8px}
    .cert-id{font-family:"Courier New", monospace;font-size:.9rem;color:#555;margin-top:6px}

    /* ONE-ROW LOGOS (auto-shrink) */
    .logo-grid{
      display:flex;           /* single row */
      flex-wrap:nowrap;       /* never wrap */
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin-top:10px;
      margin-bottom:0;
    }
    .logo-grid img{
      width:auto;
      max-width:100%;
      height:auto;
      max-height:var(--logo-h, 52px);
      object-fit:contain;
      page-break-inside:avoid;break-inside:avoid;
    }

    /* EXTRA SPACE before signature */
    .sig-gap{height:24px;}

    /* PRINT */
    @page { size: A4 landscape; margin: 10mm; }
    @media print{
      body{background:#fff!important}
      .navbar,.footer,.surface > *:not(#certificate-generator){display:none!important}
      .container{max-width:none;padding:0}
      .certificate-page{
        width:277mm!important;height:190mm!important;
        border:8mm solid #B8860B!important;border-radius:0!important;padding:15mm!important;margin:0!important;
        display:flex;flex-direction:column;
      }
      .content-wrap{flex:1 1 auto;min-height:0}
      .cert-bottom{margin-top:auto}
      .hack-logo{top:8mm!important;right:8mm!important;max-width:30mm!important;max-height:18mm!important}
      .certificate-page h1{font-size:16mm!important}
      .certificate-page .sub{font-size:4mm!important}
      .participant-name{font-size:12mm!important}
      .presented,.body-text{font-size:3.5mm!important}
      .signature-script{font-size:8mm!important}
      .sig-line{width:70mm!important}
      .cert-id{font-size:3.2mm!important}
      .sig-gap{height:10mm!important;}
      .sig-img{max-height:14mm!important;}
      .logo-grid{gap:8px;}
    }

    /* Footer */
    .cc-blue{background:#1a73e8}
    .footer{color:#fff;padding:32px 0 48px 0;margin-top:40px}
    .footer-container{max-width:1200px;margin:0 auto;padding:0 20px}
    .footer-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:24px;margin-bottom:32px}
    .footer h3{font-size:18px;font-weight:500;margin-bottom:16px;color:#fff}
    .footer p{font-size:14px;opacity:.9;margin-bottom:16px;line-height:1.5}
    .footer ul{list-style:none;padding:0;margin:0}
    .footer li{margin-bottom:8px}
    .footer a{color:#fff;text-decoration:none;font-size:14px;opacity:.9;transition:opacity .2s ease}
    .footer a:hover{opacity:1}
    .social-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:16px}
    .social-link{display:flex;flex-direction:column;align-items:center;color:#fff;text-decoration:none;padding:8px;transition:color .2s ease}
    .social-link:hover{color:#fbbf24}
    .social-link i{font-size:18px;margin-bottom:4px}
    .social-link span{font-size:11px;text-align:center}
    .footer-bottom{margin-top:32px;padding-top:24px;border-top:1px solid rgba(255,255,255,.2);text-align:center}
    .footer-bottom p{font-size:14px;opacity:.9;margin-bottom:8px}
    .footer-bottom .credits{font-size:12px;opacity:.85}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="https://HackUniversity.vercel.app" target="_blank" rel="noopener"><strong>Hack University Initiative</strong></a>
      </div>
      <div class="nav-links">
        <a href="https://codecrunchglobal.vercel.app" class="nav-link">Code Crunch Worldwide</a>
        <a href="https://gdgatfiu.vercel.app/" class="nav-link">Google Developer Group at FIU</a>
        <a href="https://colorstackatfiu.vercel.app/" class="nav-link">ColorStack at FIU</a>
        <a href="https://cahsiatfiu.vercel.app/" class="nav-link">CAHSI at FIU</a>
        <a href="https://raspberrypicrunch.vercel.app/" class="nav-link">Raspberry Pi Code Crunch</a>
        <a href="https://codecrunchglobal.vercel.app/hackuniversitydonate.html" class="nav-link">Support Us</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- MEMBERSHIP CERTIFICATE GENERATOR -->
    <section class="surface" id="certificate-generator">
      <h2 class="card-title" style="text-align:center">GENERATE YOUR CERTIFICATE ‚Ä¢ Membership</h2>
      <p class="card-description" style="text-align:center">[ OFFICIAL MEMBERSHIP CERTIFICATE ] ‚Äî Use your registered email address</p>

      <label for="certificateEmailInput" class="sr-only">Registered email address</label>
      <div class="cg-row">
        <input type="email" id="certificateEmailInput" class="cg-input" placeholder="Enter your registered email address" autocomplete="email"/>
        <button id="generateBtn" class="cg-btn" onclick="generateCertificate()">üéì Generate Membership Certificate</button>
      </div>

      <div id="certificateResult" class="surface" aria-live="polite" aria-atomic="true" style="margin-top:1rem"></div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="cc-blue footer">
    <div class="footer-container">
      <div class="footer-grid">
        <div>
          <h3>Hack University</h3>
          <p>A collaborative effort uniting student organizations and global communities to empower innovators, developers, and leaders.</p>
          <p><a href="https://hackuniversity.vercel.app">HackUniversity.vercel.app</a></p>
          <div>
            <h4 style="font-size:14px;font-weight:500;margin-bottom:12px;">Connect With Us:</h4>
            <div class="social-grid">
              <a href="https://hackuniversity-linkedin.vercel.app" class="social-link"><i class="fab fa-linkedin"></i><span>LinkedIn</span></a>
              <a href="https://www.instagram.com/codecrunchclub/" class="social-link"><i class="fab fa-instagram"></i><span>Instagram</span></a>
              <a href="https://github.com/CODE-CRUNCH-CLUB" class="social-link"><i class="fab fa-github"></i><span>GitHub</span></a>
              <a href="https://www.youtube.com/@CODECRUNCH-WORLDWIDE" class="social-link"><i class="fab fa-youtube"></i><span>YouTube</span></a>
              <a href="https://hackuniversity-registration.vercel.app" class="social-link"><i class="fab fa-discord"></i><span>Discord</span></a>
              <a href="https://hackuniversity-calendar.vercel.app" class="social-link"><i class="far fa-calendar-alt"></i><span>Calendar</span></a>
            </div>
          </div>
        </div>
        <div>
          <h3>Quick Links</h3>
          <ul>
            <li><a href="#">Mission</a></li><li><a href="#">Events</a></li><li><a href="#">Hackathons</a></li>
            <li><a href="#">Membership</a></li><li><a href="#">Join E-Board</a></li><li><a href="#">Resources</a></li><li><a href="#">Join Discord</a></li>
          </ul>
        </div>
        <div>
          <h3>Contact</h3>
          <div style="font-size:14px;opacity:.9;">
            Miami, FL<br/>
            <a href="mailto:codecrunchclub@gmail.com">codecrunchclub@gmail.com</a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>¬© <span id="year"></span> Hack University. All rights reserved.</p>
        <div class="credits">Built with ‚ù§Ô∏è for the tech community by <a href="#" target="_blank">Brian Bazurto</a></div>
      </div>
    </div>
  </footer>

  <script>
    /* ===== Settings (same API) ===== */
    const CERT_API_URL = 'https://script.google.com/macros/s/AKfycbzzc8k3xWTxdyc7jfVpLISnSpY1qwaNB_QMmYC0ORkM9UVUbKk4De5cb5upCztCepN9/exec';
    const DEFAULT_LOGOS = [
      "https://github.com/user-attachments/assets/14ba2be9-c1c3-4860-8254-5cd6a9d6bcc3",
      "https://github.com/user-attachments/assets/c0de6bf0-7ae4-4a00-a431-cf705ce5ab34",
      "https://github.com/user-attachments/assets/b8085208-d06d-4fff-a471-857c7808105c",
      "https://github.com/user-attachments/assets/5e2a6622-9702-438f-bb6b-25d8e894839e",
      "https://github.com/user-attachments/assets/c9298abf-c85b-4ff8-8b92-e7f38ddcc846",
      "https://github.com/user-attachments/assets/c4f4805e-db3b-47a2-9a7f-0b124a66dd85"
    ];
    const SIGNATURE_URL = "https://github.com/user-attachments/assets/02be41eb-2259-4d6d-9a07-1122f79d6f4b";

    /* ===== Helpers (same approach) ===== */
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function rolesToText(roles, rolesText){ if(rolesText) return String(rolesText); if(Array.isArray(roles)) return roles.join(', '); return roles || 'Member'; }
    function normalizeCert(cert){
      return {
        participantName: esc(cert?.participantName || 'Participant'),
        hackathonName: esc(cert?.hackathonName || 'Hack University'),
        date: esc(cert?.date || new Date().toLocaleDateString()),
        location: esc(cert?.location || 'Miami, FL'),
        rolesText: esc(rolesToText(cert?.roles, cert?.rolesText)),
        hackLogoUrl: cert?.hackLogoUrl || '',
        orgName: esc(cert?.orgName || 'Code Crunch Worldwide'),
        logos: Array.isArray(cert?.logos) ? cert.logos : null,
        signatureUrl: cert?.signatureUrl || SIGNATURE_URL
      };
    }
    function certHash(name, eventName, dateStr){
      const s = `${name}|${eventName}|${dateStr}`; let h = 0x811c9dc5;
      for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = (h + ((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))) >>> 0; }
      return ('00000000' + h.toString(16)).slice(-8).toUpperCase();
    }
    function logosHTML(logoUrls){
      const arr = logoUrls && logoUrls.length ? logoUrls : DEFAULT_LOGOS;
      return arr.map(u=>`<img src="${u}" alt="Partner Logo" onerror="this.style.display='none'">`).join('');
    }
    function infoBoxHTML(){
      return `<div class="infobox"><strong style="color:#28a745">üéì Membership Certificate:</strong><br>‚Ä¢ Official certificate for active members<br>‚Ä¢ Use your registered email<br>‚Ä¢ Opens a clean tab for Print / Save as PDF</div>`;
    }
    function setStatus(type, html){
      const el = document.getElementById('certificateResult');
      const cls = type==='ok'?'alert-ok':type==='error'?'alert-error':'alert-info';
      el.innerHTML = infoBoxHTML() + `<div class="alert ${cls}">${html}</div>`;
    }
    function toggleButton(loading){
      const btn = document.getElementById('generateBtn');
      if(!btn) return; btn.disabled=!!loading; btn.textContent = loading ? '‚è≥ Checking‚Ä¶' : 'üéì Generate Membership Certificate';
    }

    /* ===== Membership Certificate template ===== */
    function certPageHTMLMembership(c){
      const orgName = esc(c.orgName || 'Code Crunch Worldwide');
      const city    = esc(c.location || 'Miami, FL');
      const issued  = esc(c.date || new Date().toLocaleDateString());
      const role    = (c.rolesText && /officer|lead|director|president|vice|treasurer|secretary/i.test(c.rolesText))
                        ? c.rolesText
                        : 'Member';

      const hash8 = certHash(c.participantName, orgName, issued);
      const idText = `MB-${(issued||'').replace(/[^0-9]/g,'').slice(0,8)}-${hash8}`;

      return `
      <section class="print-page">
        <div class="certificate-page">
          ${c.hackLogoUrl ? `<img src="${c.hackLogoUrl}" alt="Org Logo" class="hack-logo" onerror="this.style.display='none'">` : ''}

          <div class="content-wrap">
            <div style="text-align:center;margin-bottom:40px">
              <h1>CERTIFICATE</h1>
              <p class="sub">OF MEMBERSHIP</p>
            </div>

            <p class="presented">This certifies that</p>
            <h2 class="participant-name">${c.participantName}</h2>

            <div class="body-text">
              <p>is recognized as an active <strong>${role}</strong> of <strong>${orgName}</strong>.</p>
              <p>Issued on <strong>${issued}</strong> in <strong>${city}</strong>.</p>
              <br>
              <p><em>Thank you for your commitment to community, learning, and collaborative innovation.</em></p>
              <br>
            </div>
          </div>

          <div class="cert-bottom">
            <div class="sig-gap"></div>
            <div class="sig-block">
              ${ c.signatureUrl
                  ? `<img class="sig-img" src="${c.signatureUrl}" alt="Signature" onerror="this.style.display='none'">`
                  : `<div class="signature-script">Brian Bazurto</div>`
              }
              <div class="sig-line"></div>
              <div style="font-size:.95rem;font-weight:700;margin-top:6px;">BRIAN BAZURTO</div>
              <div style="font-size:.9rem;font-style:italic">Code Crunch President</div>
              <div style="font-size:.9rem;font-style:italic">Hack University Initiative</div>
              <div class="cert-id">Cert ID: ${idText}</div>
            </div>

            <div class="logo-grid">${logosHTML(c.logos)}</div>
          </div>
        </div>
      </section>`;
    }

    /* Open clean print tab ‚Äî auto-shrink logos to one row */
    function openCertificatesInNewTab(certs, autoPrint=true){
      const css = document.querySelector('style')?.innerHTML || '';
      const head = `
        <meta charset="utf-8">
        <title>Membership Certificates</title>
        <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
        <style>${css}</style>`;
      const pages = certs.map(certPageHTMLMembership).join('');
      const html = `<!DOCTYPE html><html><head>${head}</head><body><div id="root">${pages}</div>
        <script>(function(){
          function waitImgs(){
            const imgs=[...document.images].filter(x=>!x.complete||x.naturalWidth===0);
            if(!imgs.length) return Promise.resolve();
            return Promise.all(imgs.map(im=>new Promise(r=>{im.onload=im.onerror=()=>r();})));
          }
          function fitLogos(){
            document.querySelectorAll('.logo-grid').forEach(grid=>{
              const n = grid.querySelectorAll('img').length || 1;
              const gap = parseFloat(getComputedStyle(grid).gap)||12;
              const w = grid.clientWidth || 600;
              const perW = (w - gap*(n-1)) / n;
              const h = Math.max(16, Math.min(52, Math.floor(perW * 0.55)));
              grid.style.setProperty('--logo-h', h + 'px');
            });
          }
          function afterLayout(){
            fitLogos();
            ${autoPrint ? 'window.print();' : ''}
          }
          window.addEventListener('resize', fitLogos);
          waitImgs().then(afterLayout);
          setTimeout(fitLogos, 0);
        })();<\/script>
      </body></html>`;

      const w = window.open('', '_blank', 'width=1300,height=900,scrollbars=yes,resizable=yes');
      if(!w){ alert('Please allow pop-ups to view/print your certificate.'); return; }
      w.opener = null; w.document.open(); w.document.write(html); w.document.close();
    }

    /* ===== Generate flow (uses same API/response) ===== */
    async function generateCertificate(){
      const email = (document.getElementById('certificateEmailInput')?.value || '').trim();
      if(!email){ setStatus('error','‚ùå Please enter your email address.'); return; }
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ setStatus('error','‚ùå Please enter a valid email address.'); return; }

      setStatus('info','‚è≥ Checking for available certificates...'); toggleButton(true);
      const ac = new AbortController(); const to = setTimeout(()=>ac.abort(),12000);

      try{
        const res = await fetch(`${CERT_API_URL}?email=${encodeURIComponent(email)}&referer=${encodeURIComponent(location.href)}`, {signal:ac.signal});
        const payload = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(payload?.error || res.statusText);

        let certs = [];
        if(Array.isArray(payload)) certs = payload;
        else if(Array.isArray(payload?.certificates)) certs = payload.certificates;
        else if(payload?.certificateData) certs = [payload];
        else if(payload?.length) certs = payload;
        else if(payload?.[0]) certs = [payload[0]];

        // For membership we keep this very permissive; if your sheet differentiates, you can add status checks here
        const base = certs.filter(c => (c?.certificateData || c?.participantName));
        if(!base.length){
          setStatus('error','No eligible membership record found for this email. If this seems wrong, please contact the organizers.');
          return;
        }

        const normalized = base.map(c => c.certificateData || c).map(normalizeCert);
        setStatus('ok', `<strong>‚úÖ Found ${normalized.length} record${normalized.length>1?'s':''}.</strong> Opening membership certificate in a new tab‚Ä¶<br><small>Tip: In the print dialog, disable ‚ÄúHeaders and footers‚Äù to remove date/URL.</small>`);
        openCertificatesInNewTab(normalized, true);
      }catch(e){
        console.error(e);
        setStatus('error','‚ùå Failed to check records. Please try again later.');
      }finally{
        clearTimeout(to); toggleButton(false);
      }
    }

    /* Init */
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('year').textContent = new Date().getFullYear();
      document.getElementById('certificateResult').innerHTML = infoBoxHTML() + 'Enter your email above to check for available certificates...';
      document.getElementById('certificateEmailInput')?.addEventListener('keydown', e=>{ if(e.key==='Enter') generateCertificate(); });
    });
  </script>
</body>
</html>
