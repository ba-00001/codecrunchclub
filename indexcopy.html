<section class="m-4">  
    <!-- =========================
    DYNAMIC FORM RESPONSE VIEWER
    Check email and display matching form responses in cards
    ========================= -->
    <section class="checklist-section" id="response-viewer" style="margin-top:3rem;">
    <h2 class="checklist-title glitch" data-text="CHECK YOUR RESPONSES">CHECK YOUR RESPONSES</h2>
    <p class="checklist-subtitle">[ FORM RESPONSE VIEWER ] ‚Äî Enter your email to view your submitted form responses</p>

    <style>
        /* ---- Small utility styles (kept inline to be drop-in) ---- */
        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
        .cg-row{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}
        .cg-input{flex:1 1 300px;padding:.75rem;border-radius:8px;border:2px solid #ddd;background:#fff;color:#333;font-size:1rem;font-family:"Courier New",monospace}
        .cg-btn{padding:.75rem 1.5rem;font-size:1rem;background:#007bff;color:#fff;border:0;border-radius:8px;cursor:pointer;font-family:"Courier New",monospace;font-weight:bold;transition:all .3s ease}
        .cg-btn[disabled]{opacity:.6;cursor:not-allowed}
        .cg-card{margin-top:1.5rem;background:#fff;padding:1rem;border-radius:8px;color:#333;font-family:"Courier New",monospace;border:2px solid #ddd}
        .infobox{background:#f8f9fa;padding:1rem;border-radius:8px;border-left:4px solid #28a745;margin-bottom:1rem}
        .alert{padding:.75rem;border-radius:4px;border:1px solid}
        .alert-info{color:#0066cc;background:#e3f2fd;border-color:#bbdefb}
        .alert-error{color:#721c24;background:#f8d7da;border-color:#f5c6cb}
        .alert-ok{color:#155724;background:#d4edda;border-color:#c3e6cb}

        /* Response card styles */
        .response-cards{
            margin-top:2rem;
            display:grid;
            gap:1.5rem;
            grid-template-columns:repeat(auto-fit, minmax(400px, 1fr))
        }
        .response-card{
            background:#fff;
            border-radius:12px;
            padding:1.5rem;
            box-shadow:0 4px 15px rgba(0,0,0,0.1);
            border:2px solid #e0e0e0;
            transition:all .3s ease
        }
        .response-card:hover{
            transform:translateY(-5px);
            box-shadow:0 8px 25px rgba(0,0,0,0.15);
            border-color:#007bff
        }
        .card-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:1rem;
            padding-bottom:1rem;
            border-bottom:2px solid #f0f0f0
        }
        .card-title{
            font-size:1.2rem;
            font-weight:700;
            color:#333;
            font-family:"Courier New",monospace
        }
        .card-timestamp{
            font-size:0.9rem;
            color:#666;
            background:#f8f9fa;
            padding:0.3rem 0.8rem;
            border-radius:6px;
            font-family:"Courier New",monospace
        }
        .data-grid{
            display:grid;
            gap:0.8rem;
            grid-template-columns:1fr
        }
        .data-item{
            display:grid;
            grid-template-columns:1fr 2fr;
            gap:0.5rem;
            padding:0.5rem 0;
            border-bottom:1px solid #f0f0f0
        }
        .data-item:last-child{
            border-bottom:none
        }
        .data-label{
            font-weight:700;
            color:#555;
            font-size:0.9rem;
            font-family:"Courier New",monospace
        }
        .data-value{
            color:#333;
            font-size:0.9rem;
            word-break:break-word;
            font-family:"Courier New",monospace
        }
        .empty-value{
            color:#999;
            font-style:italic
        }
        
        @media (max-width:768px){
            .response-cards{
                grid-template-columns:1fr
            }
            .data-item{
                grid-template-columns:1fr;
                gap:0.2rem
            }
        }
    </style>

    <label for="emailInput" class="sr-only">Your email address</label>
    <div class="cg-row">
        <input type="email" id="emailInput" class="cg-input" placeholder="Enter your email address" />
        <button id="checkBtn" class="cg-btn" onclick="checkResponses()">üîç Check Responses</button>
    </div>

    <div id="result" class="cg-card" aria-live="polite" aria-atomic="true"></div>

    <!-- Response Cards Section -->
    <div id="responsesSection" style="display:none;"></div>
    </section>

    <script>
    /* ======================
    Configuration and Helpers
    ====================== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbxMiMr7Nvo8sQMcwlDvrg252osr7ROjQZ2IerPKKybHeWpm0R_E0Dz8S8k3zFa24cRZtw/exec';

    const esc = s => String(s ?? '').replace(/[&<>"']/g, m =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])
    );

    function infoBoxHTML() {
        return `
        <div class="infobox">
            <strong style="color:#28a745">üìã Response Viewer:</strong><br>
            ‚Ä¢ <strong>Your Data</strong>: View all form responses associated with your email<br>
            ‚Ä¢ <strong>Organized Display</strong>: Each response shown in a separate card<br>
            ‚Ä¢ <strong>Complete Information</strong>: All submitted data fields displayed<br>
            ‚Ä¢ <strong>Timestamps</strong>: See when each form was submitted
        </div>`;
    }

    function setStatus(type, html) {
        const resultDiv = document.getElementById('result');
        const cls = type === 'ok' ? 'alert-ok' : type === 'error' ? 'alert-error' : 'alert-info';
        resultDiv.innerHTML = infoBoxHTML() + `<div class="alert ${cls}">${html}</div>`;
    }

    function toggleButton(loading) {
        const btn = document.getElementById('checkBtn');
        if (!btn) return;
        btn.disabled = !!loading;
        btn.textContent = loading ? '‚è≥ Loading‚Ä¶' : 'üîç Check Responses';
    }

    /* ======================
    Format timestamp for display
    ====================== */
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        
        try {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) return timestamp; // Return original if invalid
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return timestamp; // Return original if error
        }
    }

    /* ======================
    Display response cards
    ====================== */
    function showResponses(data) {
        const responsesDiv = document.getElementById('responsesSection');
        
        console.log('üé® showResponses called with data:', data);
        
        if (!data || !data.labels || !data.rows || !Array.isArray(data.rows)) {
            console.log('‚ùå Invalid data structure for showResponses');
            responsesDiv.style.display = 'none';
            return;
        }

        const { labels, rows } = data;
        const rowCount = rows.length;

        console.log(`üìä Processing ${rowCount} rows with ${labels.length} labels`);

        if (rowCount === 0) {
            setStatus('info', 
                `<strong>‚ÑπÔ∏è NO RESPONSES FOUND</strong><br>
                No form responses were found for this email address.<br>
                Please check the email address or try again later.`
            );
            responsesDiv.style.display = 'none';
            return;
        }

        // Set success status
        setStatus('ok', 
            `<strong>‚úÖ ${rowCount} RESPONSE${rowCount > 1 ? 'S' : ''} FOUND!</strong><br>
            Found ${rowCount} form response${rowCount > 1 ? 's' : ''} for your email address.<br>
            ${rowCount > 1 ? 'Each response is displayed in a separate card below.' : 'Your response is displayed below.'}`
        );

        // Generate response cards
        let cardsHTML = `
            <div style="text-align:center;margin-bottom:2rem">
                <h3 style="color:#333;font-family:'Courier New',monospace;font-size:1.4rem;margin-bottom:0.5rem">
                    üìÑ Your Form Response${rowCount > 1 ? 's' : ''}
                </h3>
                <p style="color:#666;font-family:'Courier New',monospace;font-size:1rem">
                    ${rowCount > 1 ? `${rowCount} responses found` : 'Response details'}
                </p>
            </div>
            <div class="response-cards">
        `;

        rows.forEach((row, index) => {
            // Skip if row doesn't have enough data
            if (!Array.isArray(row) || row.length === 0) {
                console.log(`‚ö†Ô∏è Skipping invalid row ${index}:`, row);
                return;
            }

            console.log(`üèóÔ∏è Building card for row ${index}:`, row);

            // Get timestamp (usually second column after email)
            const timestamp = row[1] ? formatTimestamp(row[1]) : 'N/A';
            
            cardsHTML += `
                <div class="response-card">
                    <div class="card-header">
                        <div class="card-title">Response #${index + 1}</div>
                        <div class="card-timestamp">üìÖ ${timestamp}</div>
                    </div>
                    <div class="data-grid">
            `;

            // Display all data using labels as headers
            labels.forEach((label, labelIndex) => {
                if (labelIndex < row.length) {
                    const value = row[labelIndex];
                    const displayValue = value !== null && value !== undefined && value !== '' 
                        ? esc(String(value)) 
                        : '<span class="empty-value">Not provided</span>';
                    
                    cardsHTML += `
                        <div class="data-item">
                            <div class="data-label">${esc(label)}:</div>
                            <div class="data-value">${displayValue}</div>
                        </div>
                    `;
                }
            });

            cardsHTML += `
                    </div>
                </div>
            `;
        });

        cardsHTML += `</div>`;

        console.log('üé® Generated cards HTML length:', cardsHTML.length);

        responsesDiv.innerHTML = cardsHTML;
        responsesDiv.style.display = 'block';
        
        // Smooth scroll to responses
        setTimeout(() => {
            responsesDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 200);
    }

    /* ======================
    Enhanced Main functionality with debugging
    ====================== */
    async function checkResponses() {
        const emailInput = document.getElementById('emailInput');
        const responsesDiv = document.getElementById('responsesSection');
        const email = (emailInput?.value || '').trim();

        console.log('üîç Starting response check for:', email);
        console.log('üåê Current URL:', window.location.href);
        console.log('üì° API URL:', API_URL);

        // Validate email
        if (!email) {
            console.log('‚ùå No email provided');
            setStatus('error', '‚ùå Please enter your email address.');
            responsesDiv.style.display = 'none';
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            console.log('‚ùå Invalid email format:', email);
            setStatus('error', '‚ùå Please enter a valid email address.');
            responsesDiv.style.display = 'none';
            return;
        }

        setStatus('info', '‚è≥ Searching for your form responses...');
        responsesDiv.style.display = 'none';
        toggleButton(true);

        const abortController = new AbortController();
        const timeout = setTimeout(() => {
            console.log('‚è∞ Request timeout triggered');
            abortController.abort();
        }, 15000);

        try {
            const currentUrl = window.location.href;
            const requestUrl = `${API_URL}?email=${encodeURIComponent(email)}&referer=${encodeURIComponent(currentUrl)}`;
            
            console.log('üì° Making request to:', requestUrl);
            console.log('üìß Email parameter:', encodeURIComponent(email));
            console.log('üîó Referer parameter:', encodeURIComponent(currentUrl));
            
            const response = await fetch(requestUrl, { 
                signal: abortController.signal 
            });
            
            console.log('üìà Response received:');
            console.log('  - Status:', response.status);
            console.log('  - Status Text:', response.statusText);
            console.log('  - OK:', response.ok);
            console.log('  - Headers:', [...response.headers.entries()]);
            
            // Get the raw response text first
            const responseText = await response.text();
            console.log('üìÑ Raw response text (first 500 chars):', responseText.substring(0, 500));
            console.log('üìÑ Full raw response:', responseText);
            
            // Try to parse as JSON
            let payload;
            try {
                payload = JSON.parse(responseText);
                console.log('‚úÖ Successfully parsed JSON payload:', payload);
            } catch (parseError) {
                console.error('‚ùå JSON parse error:', parseError);
                console.log('üîç Response that failed to parse:', responseText);
                setStatus('error', `‚ùå Invalid response format. Server returned: <pre>${responseText.substring(0, 200)}...</pre>`);
                return;
            }
            
            if (!response.ok) {
                console.error('‚ùå HTTP error:', response.status, payload);
                let errorMessage = 'Unknown error';
                if (payload && payload.error) {
                    errorMessage = payload.error;
                } else {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                setStatus('error', `‚ùå Server error: ${errorMessage}`);
                return;
            }

            // Check if we got the expected data structure
            if (!payload || typeof payload !== 'object') {
                console.error('‚ùå Invalid payload structure:', payload);
                setStatus('error', '‚ùå Unexpected response format from server.');
                return;
            }

            console.log('üéØ Processing valid payload...');

            // Show the responses
            showResponses(payload);

        } catch (error) {
            console.error('üí• Fetch error occurred:');
            console.error('  - Error name:', error.name);
            console.error('  - Error message:', error.message);
            console.error('  - Error stack:', error.stack);
            console.error('  - Full error object:', error);
            
            if (error.name === 'AbortError') {
                console.log('‚è∞ Request was aborted due to timeout');
                setStatus('error', '‚ùå Request timed out. Please try again.');
            } else if (error.message.includes('Failed to fetch')) {
                console.log('üåê Network error detected');
                setStatus('error', '‚ùå Network error. Check your internet connection and try again.');
            } else if (error.message.includes('CORS')) {
                console.log('üîí CORS error detected');
                setStatus('error', '‚ùå Cross-origin request blocked. Please check server configuration.');
            } else {
                setStatus('error', `‚ùå Error: ${error.message}<br><small>Check browser console for details.</small>`);
            }
            
            responsesDiv.style.display = 'none';
        } finally {
            clearTimeout(timeout);
            toggleButton(false);
        }
    }

    /* ======================
    Event Listeners
    ====================== */
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ DOM Content Loaded');
        console.log('üîß API_URL configured as:', API_URL);
        
        const input = document.getElementById('emailInput');
        
        // Allow Enter key to trigger check
        input?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                console.log('‚å®Ô∏è Enter key pressed, triggering check');
                checkResponses();
            }
        });
        
        // Initialize with info box
        document.getElementById('result').innerHTML = 
            infoBoxHTML() + 
            '<div class="alert alert-info">Enter your email above to check your volunteer status and access Form No.7...</div>';
        
        console.log('‚úÖ Page initialization complete');
    });

    /* ======================
    Debug helper function (accessible from browser console)
    ====================== */
    window.debugAPI = async function(email = 'codecrunchclub01@gmail.com') {
        console.log('üêõ Manual debug test with email:', email);
        const testUrl = `${API_URL}?email=${encodeURIComponent(email)}&referer=${encodeURIComponent(window.location.href)}`;
        console.log('üîó Test URL:', testUrl);
        
        try {
            const response = await fetch(testUrl);
            const text = await response.text();
            console.log('üì§ Debug response:', text);
            
            try {
                const json = JSON.parse(text);
                console.log('üìä Debug JSON:', json);
            } catch (e) {
                console.log('‚ùå Not valid JSON');
            }
        } catch (error) {
            console.error('üêõ Debug error:', error);
        }
    };
    
    console.log('üí° Debug tip: Run "debugAPI()" in console to test the API directly');
    </script>
</section>